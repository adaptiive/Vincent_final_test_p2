<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Speed Test - Professional Network Diagnostics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 28px 20px 24px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            max-width: 1200px;
            margin: 0 auto;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: min-height 0.3s ease;
            min-height: auto;
        }
        
        .header.modal-open {
            min-height: 600px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .role-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .role-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            padding: 24px 20px;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .role-card:hover {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-6px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
        }

        .role-card.selected {
            background: rgba(255, 255, 255, 0.22);
            border-color: #4facfe;
            box-shadow: 0 6px 24px rgba(79, 172, 254, 0.5);
            transform: translateY(-2px);
        }
        
        .role-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .role-title { 
            font-weight: 700; 
            font-size: 1.1rem; 
            margin-bottom: 6px; 
        }
        
        .role-desc { 
            font-size: 0.85rem; 
            opacity: 0.8; 
        }

        .main-container { 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding: 24px 16px; 
            gap: 24px; 
            flex-wrap: wrap; 
            max-width: 1200px;
            margin: 0 auto;
        }

        .container { 
            background: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(12px); 
            border-radius: 16px; 
            padding: 32px; 
            text-align: center; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            flex: 1 1 480px;
            max-width: 600px;
        }

        h1 { 
            margin-bottom: 24px; 
            font-size: 1.5rem; 
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); 
            font-weight: 700;
        }

        .advanced-panel { 
            background: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(12px); 
            border-radius: 16px; 
            padding: 28px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            flex: 0 0 380px;
            max-width: 420px;
        }

        .panel-title { 
            font-size: 1.3rem; 
            margin-bottom: 20px; 
            text-align: center; 
            font-weight: 700;
        }

        .feature-button { 
            background: linear-gradient(135deg, #4facfe, #00f2fe); 
            border: none; 
            color: #0a1929; 
            font-size: 0.95rem; 
            font-weight: 700; 
            padding: 12px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            margin: 6px 0; 
            width: 50%; 
        }
        
        .feature-button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(79, 172, 254, 0.4); 
        }

        /* Login card styles */
        .login-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 12px; 
            max-width: 900px; 
            margin: 16px auto 0; 
            background: rgba(0, 0, 0, 0.25); 
            padding: 14px 16px; 
            border-radius: 12px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            flex-wrap: wrap;
        }
        
        .login-left { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex: 1; 
            min-width: 300px;
            flex-wrap: wrap;
        }
        
        .login-right { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        
        .login-input { 
            padding: 12px 16px; 
            border-radius: 8px; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff !important;
            font-size: 1rem;
            min-width: 140px;
            flex: 1;
            font-weight: 500;
        }
        
        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .login-input:focus {
            outline: none;
            border-color: rgba(79, 172, 254, 0.6);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.15);
        }
        
        /* Select dropdown specific styling */
        select.login-input {
            color: #ffffff !important;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 36px;
        }
        
        .login-input option {
            background: #1a202c;
            color: #ffffff;
            padding: 8px;
        }
        
        .logged-badge { 
            padding: 8px 12px; 
            background: rgba(255, 255, 255, 0.08); 
            border-radius: 8px; 
            font-size: 0.9rem; 
        }
        
        .role-locked { 
            display: inline-block; 
            margin-left: 8px; 
            padding: 4px 8px; 
            background: rgba(0, 0, 0, 0.3); 
            border-radius: 6px; 
            font-size: 0.75rem; 
            color: #ffd93d; 
        }
        
        .login-error { 
            color: #ffb3b3; 
            background: rgba(255, 0, 0, 0.1); 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 8px; 
            width: 100%;
        }

        .diagnostics-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 16px; 
        }
        
        .diag-item { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 16px; 
            border-radius: 10px; 
            text-align: center; 
        }
        
        .diag-value { 
            font-size: 1.4rem; 
            font-weight: 700; 
            margin-bottom: 4px; 
        }
        
        .diag-label { 
            font-size: 0.8rem; 
            opacity: 0.8; 
        }

        .history-table { 
            width: 100%; 
            margin-top: 16px; 
            border-collapse: collapse; 
        }
        
        .history-table th, .history-table td { 
            padding: 10px 8px; 
            text-align: center; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            font-size: 0.85rem; 
        }
        
        .history-table th { 
            background: rgba(255, 255, 255, 0.1); 
            font-weight: 700; 
        }

        .report-section { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 16px; 
            border-radius: 10px; 
            margin-top: 16px; 
        }
        
        .report-id { 
            font-family: 'Courier New', monospace; 
            background: rgba(0, 0, 0, 0.3); 
            padding: 6px 10px; 
            border-radius: 6px; 
            margin: 8px 0; 
            font-size: 0.85rem;
        }

        .hidden { display: none !important; }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .modal.hidden {
            display: none !important;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 0;
            max-width: 550px;
            width: 100%;
            max-height: none;
            height: auto;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 28px 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 700;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 85%;
            line-height: 1.3;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.8rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 28px 32px 32px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .speed-display { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 16px; 
            margin: 24px 0; 
        }
        
        .speed-item { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px 16px; 
            border-radius: 12px; 
            border: 1px solid rgba(255, 255, 255, 0.15); 
        }
        
        .speed-value { 
            font-size: 1.8rem; 
            font-weight: 800; 
            margin-bottom: 6px; 
        }
        
        .speed-label { 
            font-size: 0.85rem; 
            opacity: 0.85; 
        }

        .test-button { 
            background: linear-gradient(135deg, #ff6b6b, #ee5a24); 
            border: none; 
            color: white; 
            font-size: 1.15rem; 
            font-weight: 700; 
            padding: 16px 40px; 
            border-radius: 14px; 
            cursor: pointer; 
            transition: all 0.25s ease; 
            box-shadow: 0 6px 16px rgba(238, 90, 36, 0.4); 
            letter-spacing: 0.3px;
        }
        
        .test-button:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 28px rgba(238, 90, 36, 0.6); 
        }
        
        .test-button:active {
            transform: translateY(-1px);
        }
        
        .test-button:disabled { 
            background: rgba(100, 100, 100, 0.4); 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none;
            opacity: 0.6;
        }

        .status { 
            margin: 16px 0; 
            font-size: 1rem; 
            min-height: 24px; 
        }
        
        .loading { 
            display: inline-block; 
            width: 18px; 
            height: 18px; 
            border: 3px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; 
            border-top-color: white; 
            animation: spin 0.8s linear infinite; 
            margin-right: 8px; 
            vertical-align: middle;
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        .timestamp { 
            margin-top: 16px; 
            font-size: 0.85rem; 
            opacity: 0.7; 
        }

        /* Connection Checker Styles */
        .connection-checker {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .connection-check-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .connection-check-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .connection-check-button:active {
            transform: translateY(0);
        }

        .connection-icon {
            font-size: 1.2rem;
        }

        .connection-status {
            margin-top: 16px;
            padding: 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .connection-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .connection-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
            animation: pulse 2s infinite;
        }

        .connection-indicator.disconnected {
            background: #ef4444;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
        }

        .connection-indicator.checking {
            background: #f59e0b;
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .connection-message {
            font-size: 0.95rem;
            font-weight: 500;
            flex: 1;
        }

        @media (max-width: 900px) {
            .main-container { 
                flex-direction: column; 
                align-items: center; 
            }
            
            .container, .advanced-panel {
                max-width: 100%;
                flex-basis: auto;
            }
            
            .role-selection { 
                grid-template-columns: 1fr; 
            }
            
            .login-card {
                flex-direction: column;
                align-items: stretch;
            }
            
            .login-left {
                min-width: auto;
            }
            
            .modal-content {
                width: 95%;
                max-width: 100%;
            }
            
            .modal-header h2 {
                font-size: 1.1rem;
                max-width: 80%;
            }
            
            .modal-body {
                padding: 16px 20px 20px;
            }
            
            .diagnostics-grid { 
                grid-template-columns: 1fr; 
            }
            
            .speed-display { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì° Professional WiFi Speed Test</h1>
        <p>Network Performance Analysis & Diagnostics</p>
        
        <!-- Login / Role selection -->
        <div id="loginBar" style="margin-top:12px;">
            <div class="login-card">
                <div class="login-left">
                    <select id="loginRoleSelect" class="login-input">
                        <option value="home_user">Home User (Sign Up Required)</option>
                        <option value="it_admin">IT Administrator</option>
                        <option value="isp_support">ISP Support</option>
                    </select>
                    <input id="loginUsername" class="login-input" placeholder="Username" />
                    <input id="loginPassword" class="login-input" type="password" placeholder="Password" />
                </div>
                <div class="login-right">
                    <button class="feature-button" id="loginBtn">Login</button>
                    <button class="feature-button hidden" id="logoutBtn">Logout</button>
                    <button class="feature-button" id="signupBtn" style="background: linear-gradient(135deg, #7ee787, #4facfe);">Sign Up</button>
                    <button class="feature-button" id="forgotPasswordBtn" style="background: linear-gradient(135deg, #f59e0b, #ec4899); font-size: 0.85rem; padding: 8px 16px;">Forgot Password?</button>
                    <div id="loggedInInfo" class="logged-badge" aria-live="polite"></div>
                </div>
                <div style="width:100%"><div id="loginError" class="login-error hidden"></div></div>
            </div>
        </div>
        
        <!-- Sign Up Modal -->
        <div id="signupModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create Home User Account</h2>
                    <button class="close-btn" onclick="closeSignupModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <p style="opacity: 0.9; margin-bottom: 18px; font-size: 0.95rem;">Create an account to use the WiFi Speed Tester. All fields are required.</p>
                    <input id="signupUsername" class="login-input" style="width: 100%; margin-bottom: 14px;" placeholder="Username (min 3 characters)" />
                    <input id="signupDisplayName" class="login-input" style="width: 100%; margin-bottom: 14px;" placeholder="Display Name (optional)" />
                    <input id="signupPassword" class="login-input" type="password" style="width: 100%; margin-bottom: 14px;" placeholder="Password (min 4 characters, required)" />
                    <input id="signupPasswordConfirm" class="login-input" type="password" style="width: 100%; margin-bottom: 14px;" placeholder="Re-enter Password" />
                    <input id="signupSecurityQuestion" class="login-input" style="width: 100%; margin-bottom: 14px;" placeholder="Security Question" />
                    <input id="signupSecurityAnswer" class="login-input" style="width: 100%; margin-bottom: 16px;" placeholder="Answer to question" />
                    <div id="signupError" class="login-error hidden"></div>
                    <div style="display: flex; gap: 10px; margin-top: 18px;">
                        <button class="feature-button" onclick="submitSignup()" style="flex: 1; padding: 12px 18px; font-size: 1rem;">Create Account</button>
                        <button class="feature-button" onclick="closeSignupModal()" style="flex: 0 0 auto; background: rgba(255,255,255,0.1); padding: 12px 14px; font-size: 1rem; white-space: nowrap;">Go Back</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div id="forgotPasswordModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Recover Password</h2>
                    <button class="close-btn" onclick="closeForgotPasswordModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="forgotPasswordStep1" class="recovery-step">
                        <p style="opacity: 0.9; margin-bottom: 18px; font-size: 1rem;">Enter your username to verify your identity.</p>
                        <input id="forgotUsername" class="login-input" style="width: 100%; margin-bottom: 14px;" placeholder="Username" />
                        <div id="forgotPasswordError" class="login-error hidden"></div>
                        <button class="feature-button" onclick="fetchSecurityQuestion()" style="width: 100%; padding: 12px 18px; font-size: 1rem;">Next</button>
                    </div>
                    
                    <div id="forgotPasswordStep2" class="recovery-step hidden">
                        <p style="opacity: 0.9; margin-bottom: 14px; font-size: 1rem;">Answer your security question:</p>
                        <div id="securityQuestionDisplay" style="background: rgba(255,255,255,0.1); padding: 14px; border-radius: 8px; margin-bottom: 14px; font-weight: 500;"></div>
                        <input id="securityAnswerInput" class="login-input" style="width: 100%; margin-bottom: 14px;" placeholder="Your answer" />
                        <input id="newPasswordInput" class="login-input" type="password" style="width: 100%; margin-bottom: 16px;" placeholder="New password (min 4 characters)" />
                        <div id="forgotPasswordError2" class="login-error hidden"></div>
                        <div style="display: flex; gap: 10px;">
                            <button class="feature-button" onclick="resetPassword()" style="flex: 1; padding: 12px 18px; font-size: 1rem;">Reset Password</button>
                            <button class="feature-button" onclick="goBackForgotPassword()" style="flex: 0 0 auto; background: rgba(255,255,255,0.1); padding: 12px 14px; font-size: 1rem; white-space: nowrap;">‚Üê</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="role-selection" id="roleSelection">
            <div class="role-card" data-role="home_user">
                <div class="role-title">üè† Home User</div>
                <div class="role-desc">Simple speed testing</div>
            </div>
            <div class="role-card" data-role="it_admin">
                <div class="role-title">üë®‚Äçüíª IT Administrator</div>
                <div class="role-desc">Network management</div>
            </div>
            <div class="role-card" data-role="isp_support">
                <div class="role-title">üìû ISP Support</div>
                <div class="role-desc">Customer support tools</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Main Speed Test Panel -->
        <div class="container">
            <h1 id="dashboardTitle">Select Your Role</h1>
            
            <div class="speed-display">
                <div class="speed-item">
                    <div class="speed-value" id="download">--</div>
                    <div class="speed-label">Download (Mbps)</div>
                </div>
                <div class="speed-item">
                    <div class="speed-value" id="upload">--</div>
                    <div class="speed-label">Upload (Mbps)</div>
                </div>
                <div class="speed-item">
                    <div class="speed-value" id="ping">--</div>
                    <div class="speed-label">Ping (ms)</div>
                </div>
            </div>

            <button class="test-button" id="startTest" onclick="startSpeedTest()">
                Start Speed Test
            </button>

            <button class="test-button reset-button hidden" id="resetTest" onclick="resetSpeedTest()" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                Reset Test
            </button>

            <div class="status" id="status"></div>
            <div class="timestamp" id="timestamp"></div>
            
            <!-- Connection Status Check -->
            <div class="connection-checker" id="connectionChecker">
                <button class="connection-check-button" onclick="checkConnection()">
                    <span class="connection-icon">üåê</span> Check Internet Connection
                </button>
                <div id="connectionStatus" class="connection-status hidden">
                    <div id="connectionIndicator" class="connection-indicator"></div>
                    <div id="connectionMessage" class="connection-message"></div>
                </div>
            </div>
        </div>

        <!-- Advanced Features Panel -->
        <div class="advanced-panel hidden" id="advancedPanel">
            <div class="panel-title" id="panelTitle">Advanced Features</div>
            
            <!-- IT Admin Features -->
            <div id="itAdminFeatures" class="hidden">
                <button class="feature-button" onclick="loadHistory()">üìä View Test History</button>
                <button class="feature-button" onclick="loadDiagnostics()">üîç Network Diagnostics</button>
                <button class="feature-button" onclick="loadReports()">üìÅ View ISP Reports</button>
                
                <div id="diagnosticsData" class="hidden">
                    <div class="diagnostics-grid">
                        <div class="diag-item">
                            <div class="diag-value" id="testsToday">--</div>
                            <div class="diag-label">Tests Today</div>
                        </div>
                        <div class="diag-item">
                            <div class="diag-value" id="avgDownload">--</div>
                            <div class="diag-label">Avg Download</div>
                        </div>
                        <div class="diag-item">
                            <div class="diag-value" id="avgUpload">--</div>
                            <div class="diag-label">Avg Upload</div>
                        </div>
                        <div class="diag-item">
                            <div class="diag-value" id="avgPing">--</div>
                            <div class="diag-label">Avg Ping</div>
                        </div>
                    </div>
                </div>
                
                <div id="historyData" class="hidden">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Download</th>
                                <th>Upload</th>
                                <th>Ping</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                </div>
                <!-- Reports panel for IT Admin -->
                <div id="reportsData" class="hidden" style="margin-top:16px;text-align:left;">
                    <h3>ISP Shared Reports</h3>
                    <div id="reportsList" style="max-height:240px;overflow:auto;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;">
                        <!-- list populated by JS -->
                    </div>
                    <div id="reportPreview" style="margin-top:12px;display:none;padding:10px;background:#fff;color:#000;border-radius:8px;">
                        <!-- preview inserted here -->
                    </div>
                </div>
            </div>

            <!-- ISP Support Features -->
            <div id="ispSupportFeatures" class="hidden">
                <button class="feature-button" onclick="loadHistory()">üìä View Test History</button>
                <button class="feature-button" onclick="loadDiagnostics()">üîç Network Diagnostics</button>
                <button class="feature-button" onclick="generateReport()">üìã Generate Report</button>
                
                <div id="reportData" class="hidden">
                    <div class="report-section">
                        <h3>Customer Support Report</h3>
                        <div class="report-id" id="reportId">Report ID will appear here</div>
                        <div id="reportSummary">Report summary will appear here</div>
                    </div>
                </div>
                
                <div id="diagnosticsData2" class="hidden">
                    <div class="diagnostics-grid">
                        <div class="diag-item">
                            <div class="diag-value" id="testsToday2">--</div>
                            <div class="diag-label">Tests Today</div>
                        </div>
                        <div class="diag-item">
                            <div class="diag-value" id="avgDownload2">--</div>
                            <div class="diag-label">Avg Download</div>
                        </div>
                        <div class="diag-item">
                            <div class="diag-value" id="avgUpload2">--</div>
                            <div class="diag-label">Avg Upload</div>
                        </div>
                        <div class="diag-item">
                            <div class="diag-value" id="avgPing2">--</div>
                            <div class="diag-label">Avg Ping</div>
                        </div>
                    </div>
                </div>
                
                <div id="historyData2" class="hidden">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Download</th>
                                <th>Upload</th>
                                <th>Ping</th>
                                <th>Server</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody2">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
    let isTestRunning = false;
    let pollInterval;
    let currentRole = null;
    let isAuthenticated = false;

        // Role management
        function selectRole(role) {
            currentRole = role;
            
            // Update UI
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-role="${role}"]`).classList.add('selected');
            
            // Set role on server
            fetch('/set-role', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role: role})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    setupDashboard(role);
                } else {
                    // show backend message if role change was denied (e.g., after login)
                    const loginErr = document.getElementById('loginError');
                    if (loginErr) {
                        loginErr.textContent = data.message || 'Cannot change role after login';
                        loginErr.classList.remove('hidden');
                    }
                    // revert UI selection to the current session role (if any)
                    fetch('/get-role').then(r => r.json()).then(d => {
                        const current = d.role || 'home_user';
                        document.querySelectorAll('.role-card').forEach(card => card.classList.remove('selected'));
                        const el = document.querySelector(`[data-role="${current}"]`);
                        if (el) el.classList.add('selected');
                        setupDashboard(current);
                    }).catch(()=>{});
                }
            });
        }

        function setupDashboard(role) {
            const dashboardTitle = document.getElementById('dashboardTitle');
            const advancedPanel = document.getElementById('advancedPanel');
            const itFeatures = document.getElementById('itAdminFeatures');
            const ispFeatures = document.getElementById('ispSupportFeatures');
            
            // Reset all panels
            advancedPanel.classList.add('hidden');
            itFeatures.classList.add('hidden');
            ispFeatures.classList.add('hidden');
            
            switch(role) {
                case 'home_user':
                    dashboardTitle.textContent = 'üè† Home User Dashboard';
                    break;
                case 'it_admin':
                    dashboardTitle.textContent = 'üë®‚Äçüíª IT Administrator Dashboard';
                    advancedPanel.classList.remove('hidden');
                    itFeatures.classList.remove('hidden');
                    document.getElementById('panelTitle').textContent = 'Network Management Tools';
                    break;
                case 'isp_support':
                    dashboardTitle.textContent = 'üìû ISP Support Dashboard';
                    advancedPanel.classList.remove('hidden');
                    ispFeatures.classList.remove('hidden');
                    document.getElementById('panelTitle').textContent = 'Customer Support Tools';
                    break;
            }
        }

        // Speed test functions
        function startSpeedTest() {
            if (isTestRunning || !currentRole) {
                if (!currentRole) {
                    alert('Please select your role first');
                }
                return;
            }
            
            const button = document.getElementById('startTest');
            const status = document.getElementById('status');
            
            button.disabled = true;
            button.textContent = 'Testing...';
            status.innerHTML = '<span class="loading"></span>Running speed test...';
            isTestRunning = true;

            // Start the test
            fetch('/start-test')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'started') {
                        // Start polling for results
                        pollInterval = setInterval(checkResults, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error starting test:', error);
                    resetButton();
                });
        }

        function checkResults() {
            fetch('/results')
                .then(response => response.json())
                .then(data => {
                    // Update status
                    if (data.status && data.testing) {
                        document.getElementById('status').innerHTML = `<span class="loading"></span>${data.status}`;
                    }
                    
                    if (!data.testing && data.timestamp) {
                        // Test completed
                        clearInterval(pollInterval);
                        updateResults(data);
                        resetButton();
                    } else if (data.testing) {
                        // Update partial results if available
                        if (data.download > 0) {
                            document.getElementById('download').textContent = data.download;
                        }
                        if (data.ping > 0) {
                            document.getElementById('ping').textContent = data.ping;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking results:', error);
                    clearInterval(pollInterval);
                    resetButton();
                });
        }

        function updateResults(data) {
            document.getElementById('download').textContent = data.download || '--';
            document.getElementById('upload').textContent = data.upload || '--';
            document.getElementById('ping').textContent = data.ping || '--';
            document.getElementById('timestamp').textContent = 
                data.timestamp ? `Last test: ${data.timestamp}` : '';
            document.getElementById('status').textContent = 'Test completed!';
        }

        function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const indicatorDiv = document.getElementById('connectionIndicator');
            const messageDiv = document.getElementById('connectionMessage');
            const button = document.querySelector('.connection-check-button');
            
            // Show status div and set to checking state
            statusDiv.classList.remove('hidden');
            indicatorDiv.className = 'connection-indicator checking';
            messageDiv.textContent = 'Checking internet connection...';
            button.disabled = true;
            
            fetch('/check-connection')
                .then(response => response.json())
                .then(data => {
                    button.disabled = false;
                    
                    if (data.connected) {
                        indicatorDiv.className = 'connection-indicator connected';
                        messageDiv.innerHTML = `<strong>‚úì Connected:</strong> ${data.message}`;
                    } else {
                        indicatorDiv.className = 'connection-indicator disconnected';
                        messageDiv.innerHTML = `<strong>‚úó Disconnected:</strong> ${data.message}`;
                    }
                    
                    // Add details if available
                    if (data.dns_working) {
                        messageDiv.innerHTML += '<br><small style="opacity: 0.8;">DNS resolution: Working</small>';
                    }
                    if (data.internet_reachable) {
                        messageDiv.innerHTML += '<br><small style="opacity: 0.8;">Internet access: Available</small>';
                    }
                })
                .catch(error => {
                    button.disabled = false;
                    indicatorDiv.className = 'connection-indicator disconnected';
                    messageDiv.innerHTML = `<strong>‚úó Error:</strong> Unable to check connection. You may not be connected to the internet.`;
                    console.error('Connection check error:', error);
                });
        }

        // Password Recovery Functions
        function openForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('hidden');
            document.querySelector('.header').classList.add('modal-open');
            document.getElementById('forgotPasswordStep1').classList.remove('hidden');
            document.getElementById('forgotPasswordStep2').classList.add('hidden');
            document.getElementById('forgotUsername').value = '';
            document.getElementById('securityAnswerInput').value = '';
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('forgotPasswordError').classList.add('hidden');
            document.getElementById('forgotPasswordError2').classList.add('hidden');
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.add('hidden');
            document.querySelector('.header').classList.remove('modal-open');
        }

        function fetchSecurityQuestion() {
            const username = document.getElementById('forgotUsername').value.trim();
            const errDiv = document.getElementById('forgotPasswordError');
            
            errDiv.classList.add('hidden');
            
            if (!username) {
                errDiv.textContent = 'Please enter your username';
                errDiv.classList.remove('hidden');
                return;
            }
            
            fetch('/forgot-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: username })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('securityQuestionDisplay').textContent = '‚ùì ' + data.security_question;
                    document.getElementById('forgotPasswordStep1').classList.add('hidden');
                    document.getElementById('forgotPasswordStep2').classList.remove('hidden');
                } else {
                    errDiv.textContent = data.message || 'User not found';
                    errDiv.classList.remove('hidden');
                }
            })
            .catch(error => {
                errDiv.textContent = 'Error: Unable to fetch security question';
                errDiv.classList.remove('hidden');
                console.error('Error:', error);
            });
        }

        function resetPassword() {
            const username = document.getElementById('forgotUsername').value.trim();
            const securityAnswer = document.getElementById('securityAnswerInput').value.trim();
            const newPassword = document.getElementById('newPasswordInput').value;
            const errDiv = document.getElementById('forgotPasswordError2');
            
            errDiv.classList.add('hidden');
            
            if (!securityAnswer) {
                errDiv.textContent = 'Please answer the security question';
                errDiv.classList.remove('hidden');
                return;
            }
            
            if (!newPassword) {
                errDiv.textContent = 'Please enter a new password';
                errDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword.length < 4) {
                errDiv.textContent = 'Password must be at least 4 characters';
                errDiv.classList.remove('hidden');
                return;
            }
            
            fetch('/verify-security-answer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    security_answer: securityAnswer,
                    new_password: newPassword
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success message
                    errDiv.textContent = '‚úì ' + data.message;
                    errDiv.style.color = '#10b981';
                    errDiv.classList.remove('hidden');
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeForgotPasswordModal();
                        errDiv.style.color = '#ef4444';
                    }, 2000);
                } else {
                    errDiv.textContent = data.message || 'Password reset failed';
                    errDiv.classList.remove('hidden');
                }
            })
            .catch(error => {
                errDiv.textContent = 'Error: Unable to reset password';
                errDiv.classList.remove('hidden');
                console.error('Error:', error);
            });
        }

        function goBackForgotPassword() {
            document.getElementById('forgotPasswordStep1').classList.remove('hidden');
            document.getElementById('forgotPasswordStep2').classList.add('hidden');
        }

        function resetButton() {
            const button = document.getElementById('startTest');
            const resetButton = document.getElementById('resetTest');
            button.disabled = false;
            button.textContent = 'Start Speed Test';
            isTestRunning = false;
            
            // Show reset button after test completes
            resetButton.classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('status').textContent = '';
            }, 3000);
        }

        function resetSpeedTest() {
            // Call the backend reset endpoint
            fetch('/reset-test')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Clear the UI
                        document.getElementById('download').textContent = '--';
                        document.getElementById('upload').textContent = '--';
                        document.getElementById('ping').textContent = '--';
                        document.getElementById('timestamp').textContent = '';
                        document.getElementById('status').textContent = '';
                        
                        // Hide reset button and show start button
                        document.getElementById('resetTest').classList.add('hidden');
                        document.getElementById('startTest').classList.remove('hidden');
                        
                        // Enable start button
                        document.getElementById('startTest').disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error resetting test:', error);
                    document.getElementById('status').textContent = 'Error resetting test';
                });
        }

        // Advanced features
        function loadHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    const tbody = currentRole === 'it_admin' ? 
                        document.getElementById('historyTableBody') :
                        document.getElementById('historyTableBody2');
                    
                    tbody.innerHTML = '';
                    
                    data.history.slice(-10).forEach(test => {
                        const row = tbody.insertRow();
                        const [date, time] = test.timestamp.split(' ');
                        row.insertCell(0).textContent = date;
                        row.insertCell(1).textContent = time;
                        row.insertCell(2).textContent = test.download + ' Mbps';
                        row.insertCell(3).textContent = test.upload + ' Mbps';
                        row.insertCell(4).textContent = test.ping + ' ms';
                        if (currentRole === 'isp_support') {
                            row.insertCell(5).textContent = test.server || 'Unknown';
                        }
                    });
                    
                    const historyDiv = currentRole === 'it_admin' ? 
                        document.getElementById('historyData') :
                        document.getElementById('historyData2');
                    historyDiv.classList.remove('hidden');
                })
                .catch(error => console.error('Error loading history:', error));
        }

        function loadDiagnostics() {
            fetch('/diagnostics')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    const suffix = currentRole === 'it_admin' ? '' : '2';
                    document.getElementById('testsToday' + suffix).textContent = data.tests_today;
                    document.getElementById('avgDownload' + suffix).textContent = data.avg_download + ' Mbps';
                    document.getElementById('avgUpload' + suffix).textContent = data.avg_upload + ' Mbps';
                    document.getElementById('avgPing' + suffix).textContent = data.avg_ping + ' ms';
                    
                    document.getElementById('diagnosticsData' + suffix).classList.remove('hidden');
                })
                .catch(error => console.error('Error loading diagnostics:', error));
        }

        function generateReport() {
            // Allow agent to optionally enter a customer username for context
            const customer = prompt('Enter customer username for report (optional):');
            const url = customer ? `/generate-report?customer=${encodeURIComponent(customer)}` : '/generate-report';
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        const loginErr = document.getElementById('loginError');
                        if (loginErr) { loginErr.textContent = data.error; loginErr.classList.remove('hidden'); }
                        return;
                    }

                    document.getElementById('reportId').textContent = `Report ID: ${data.report_id}`;
                    document.getElementById('reportSummary').textContent = data.summary;
                    // show HTML snippet if provided
                    if (data.report_html) {
                        const htmlContainer = document.getElementById('reportData');
                        htmlContainer.classList.remove('hidden');
                        // insert HTML snippet into a subcontainer
                        let snippet = document.getElementById('reportSnippet');
                        if (!snippet) {
                            snippet = document.createElement('div');
                            snippet.id = 'reportSnippet';
                            snippet.style.background = '#fff';
                            snippet.style.color = '#000';
                            snippet.style.padding = '12px';
                            snippet.style.borderRadius = '8px';
                            snippet.style.marginTop = '8px';
                            document.getElementById('reportData').appendChild(snippet);
                        }
                        snippet.innerHTML = data.report_html;

                        // add download JSON button
                        let dl = document.getElementById('downloadReportBtn');
                        if (!dl) {
                            dl = document.createElement('button');
                            dl.id = 'downloadReportBtn';
                            dl.className = 'feature-button';
                            dl.textContent = 'Download JSON Report';
                            dl.style.marginTop = '10px';
                            dl.onclick = function() {
                                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `${data.report_id || 'report'}.json`;
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                URL.revokeObjectURL(url);
                            };
                            document.getElementById('reportData').appendChild(dl);
                        }
                    } else {
                        document.getElementById('reportData').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error generating report:', error);
                    const loginErr = document.getElementById('loginError');
                    if (loginErr) { loginErr.textContent = 'Error generating report: ' + error; loginErr.classList.remove('hidden'); }
                });
        }

        // IT Admin: load stored reports created by ISP agents
        function loadReports() {
            fetch('/reports')
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    const list = document.getElementById('reportsList');
                    list.innerHTML = '';

                    if (!data.reports || data.reports.length === 0) {
                        list.textContent = 'No reports available.';
                    } else {
                        data.reports.forEach(r => {
                            const item = document.createElement('div');
                            item.style.display = 'flex';
                            item.style.justifyContent = 'space-between';
                            item.style.alignItems = 'center';
                            item.style.padding = '6px';
                            item.style.borderBottom = '1px dashed rgba(255,255,255,0.04)';

                            const meta = document.createElement('div');
                            meta.innerHTML = `<strong>${r.report_id}</strong><br><small>${r.generated_at} ‚Äî by ${r.creator || 'unknown'} ‚Äî customer: ${r.customer || 'N/A'}</small>`;
                            item.appendChild(meta);

                            const ctl = document.createElement('div');
                            const view = document.createElement('button');
                            view.className = 'feature-button';
                            view.style.padding = '6px 10px';
                            view.style.marginLeft = '8px';
                            view.textContent = 'View';
                            view.onclick = function() { viewReport(r.report_id); };
                            ctl.appendChild(view);

                            const dl = document.createElement('button');
                            dl.className = 'feature-button';
                            dl.style.padding = '6px 10px';
                            dl.style.marginLeft = '8px';
                            dl.textContent = 'Download';
                            dl.onclick = function() {
                                fetch(`/reports/${encodeURIComponent(r.report_id)}`)
                                    .then(res => res.json())
                                    .then(payload => {
                                        const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `${r.report_id || 'report'}.json`;
                                        document.body.appendChild(a);
                                        a.click();
                                        a.remove();
                                        URL.revokeObjectURL(url);
                                    })
                                    .catch(err => alert('Failed to download report: ' + err));
                            };
                            ctl.appendChild(dl);

                            item.appendChild(ctl);
                            list.appendChild(item);
                        });
                    }

                    document.getElementById('reportsData').classList.remove('hidden');
                    document.getElementById('reportPreview').style.display = 'none';
                })
                .catch(err => console.error('Error loading reports:', err));
        }

        function viewReport(reportId) {
            fetch(`/reports/${encodeURIComponent(reportId)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error || 'Failed to load report');
                        return;
                    }
                    const preview = document.getElementById('reportPreview');
                    // if report provides HTML, render it; otherwise show JSON
                    if (data.report_html) {
                        preview.innerHTML = data.report_html;
                    } else {
                        preview.textContent = JSON.stringify(data, null, 2);
                    }
                    preview.style.display = 'block';

                    // add download button into preview if not present
                    if (!document.getElementById('downloadReportPreviewBtn')) {
                        const btn = document.createElement('button');
                        btn.id = 'downloadReportPreviewBtn';
                        btn.className = 'feature-button';
                        btn.textContent = 'Download Report JSON';
                        btn.style.marginTop = '8px';
                        btn.onclick = function() {
                            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url; a.download = `${data.report_id || 'report'}.json`;
                            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                        };
                        preview.appendChild(btn);
                    }
                })
                .catch(err => console.error('Error fetching report:', err));
        }

        // Sign up functions
        function openSignupModal() {
            // Only allow signup for home_user role
            const role = document.getElementById('loginRoleSelect').value;
            if (role !== 'home_user') {
                const loginErr = document.getElementById('loginError');
                if (loginErr) {
                    loginErr.textContent = 'Sign up is only available for Home Users. IT Admin and ISP accounts are created by administrators.';
                    loginErr.classList.remove('hidden');
                }
                return;
            }
            
            document.getElementById('signupModal').classList.remove('hidden');
            document.querySelector('.header').classList.add('modal-open');
            document.getElementById('signupUsername').value = '';
            document.getElementById('signupDisplayName').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupPasswordConfirm').value = '';
            document.getElementById('signupSecurityQuestion').value = '';
            document.getElementById('signupSecurityAnswer').value = '';
            document.getElementById('signupError').classList.add('hidden');
        }
        
        function closeSignupModal() {
            document.getElementById('signupModal').classList.add('hidden');
            document.querySelector('.header').classList.remove('modal-open');
        }
        
        function submitSignup() {
            const username = document.getElementById('signupUsername').value.trim();
            const displayName = document.getElementById('signupDisplayName').value.trim();
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            const securityQuestion = document.getElementById('signupSecurityQuestion').value.trim();
            const securityAnswer = document.getElementById('signupSecurityAnswer').value.trim();
            const signupErr = document.getElementById('signupError');
            
            // Clear previous errors
            signupErr.classList.add('hidden');
            
            // Validate
            if (!username) {
                signupErr.textContent = 'Username is required';
                signupErr.classList.remove('hidden');
                return;
            }
            
            if (username.length < 3) {
                signupErr.textContent = 'Username must be at least 3 characters';
                signupErr.classList.remove('hidden');
                return;
            }
            
            // Password is now required
            if (!password) {
                signupErr.textContent = 'Password is required';
                signupErr.classList.remove('hidden');
                return;
            }
            
            if (password.length < 4) {
                signupErr.textContent = 'Password must be at least 4 characters';
                signupErr.classList.remove('hidden');
                return;
            }
            
            if (!passwordConfirm) {
                signupErr.textContent = 'Please confirm your password';
                signupErr.classList.remove('hidden');
                return;
            }
            
            if (password !== passwordConfirm) {
                signupErr.textContent = 'Passwords do not match';
                signupErr.classList.remove('hidden');
                return;
            }
            
            if (!securityQuestion) {
                signupErr.textContent = 'Security question is required for password recovery';
                signupErr.classList.remove('hidden');
                return;
            }
            
            if (!securityAnswer) {
                signupErr.textContent = 'Security answer is required';
                signupErr.classList.remove('hidden');
                return;
            }
            
            // Submit signup
            fetch('/signup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    display_name: displayName || username,
                    password: password,
                    security_question: securityQuestion,
                    security_answer: securityAnswer
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    // Close modal and update UI as logged in
                    closeSignupModal();
                    currentRole = 'home_user';
                    isAuthenticated = true;
                    document.getElementById('loginRoleSelect').disabled = true;
                    document.querySelectorAll('.role-card').forEach(c => c.classList.add('disabled'));
                    const logged = document.getElementById('loggedInInfo');
                    if (logged) logged.innerHTML = `<strong>${data.username}</strong> <span class="role-locked">home_user</span>`;
                    document.getElementById('loginBtn').classList.add('hidden');
                    document.getElementById('signupBtn').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.getElementById('roleSelection').classList.add('hidden');
                    document.querySelector('.main-container').classList.remove('hidden');
                    setupDashboard('home_user');
                } else {
                    signupErr.textContent = data.message || 'Sign up failed';
                    signupErr.classList.remove('hidden');
                }
            })
            .catch(err => {
                signupErr.textContent = 'Sign up error: ' + err;
                signupErr.classList.remove('hidden');
            });
        }

        // Role selection and login initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Hide role selection and main UI until authenticated
            const roleSelectionEl = document.getElementById('roleSelection');
            const mainContainerEl = document.querySelector('.main-container');
            roleSelectionEl.classList.add('hidden');
            mainContainerEl.classList.add('hidden');

            // Role card click -> preselect in login UI
            document.querySelectorAll('.role-card').forEach(card => {
                card.addEventListener('click', function() {
                    const role = this.getAttribute('data-role');
                    document.getElementById('loginRoleSelect').value = role;
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                    // Always show password field for all roles
                    document.getElementById('loginPassword').style.display = '';
                    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Check authentication status on load
            fetch('/get-role')
                .then(r => r.json())
                .then(data => {
                    if (data.authenticated) {
                        // authenticated: show main UI, but hide the pre-login role-selection
                        roleSelectionEl.classList.add('hidden');
                        mainContainerEl.classList.remove('hidden');
                        document.getElementById('loginBtn').classList.add('hidden');
                        document.getElementById('signupBtn').classList.add('hidden');
                        document.getElementById('logoutBtn').classList.remove('hidden');
                        document.getElementById('loggedInInfo').textContent = `${data.username || 'guest'} (${data.config ? data.config.name : data.role})`;
                        currentRole = data.role || 'home_user';
                        // disable role cards to prevent switching after login and mark selected
                        document.getElementById('loginRoleSelect').disabled = true;
                        document.querySelectorAll('.role-card').forEach(c => c.classList.add('disabled'));
                        const selectedEl = document.querySelector(`[data-role="${currentRole}"]`);
                        if (selectedEl) {
                            document.querySelectorAll('.role-card').forEach(card => card.classList.remove('selected'));
                            selectedEl.classList.add('selected');
                        }
                        setupDashboard(currentRole);
                        // Load previous results
                        fetch('/results')
                            .then(response => response.json())
                            .then(d => { if (d.timestamp && !d.testing) updateResults(d); })
                            .catch(() => {});
                    } else {
                        // not authenticated: show role-selection so user can preselect role and keep features hidden
                        roleSelectionEl.classList.remove('hidden');
                        mainContainerEl.classList.add('hidden');
                        document.getElementById('loginBtn').classList.remove('hidden');
                        document.getElementById('logoutBtn').classList.add('hidden');
                        document.getElementById('loggedInInfo').textContent = '';
                    }
                })
                .catch(() => {
                    // On error, stay in login-only mode
                    roleSelectionEl.classList.add('hidden');
                    mainContainerEl.classList.add('hidden');
                });

            // Sign up button behavior
            document.getElementById('signupBtn').addEventListener('click', function() {
                openSignupModal();
            });

            // Forgot Password button behavior
            document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
                openForgotPasswordModal();
            });

            // Login button behavior
            document.getElementById('loginBtn').addEventListener('click', function() {
                const role = document.getElementById('loginRoleSelect').value;
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;

                const loginErrElm = document.getElementById('loginError');
                if (loginErrElm) { loginErrElm.textContent = ''; loginErrElm.classList.add('hidden'); }

                // Client-side validation: require username/password for all roles (including home_user)
                if (!username) {
                    if (loginErrElm) { 
                        if (role === 'home_user') {
                            loginErrElm.textContent = 'Please sign up first. Home Users must create an account to continue.';
                        } else {
                            loginErrElm.textContent = 'Please enter a username for this role';
                        }
                        loginErrElm.classList.remove('hidden'); 
                    }
                    return;
                }
                
                if (!password) {
                    if (loginErrElm) { loginErrElm.textContent = 'Please enter a password'; loginErrElm.classList.remove('hidden'); }
                    return;
                }

                fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({role: role, username: username, password: password})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentRole = data.role;
                        isAuthenticated = true;
                        // disable role selection controls to avoid confusion
                        document.getElementById('loginRoleSelect').disabled = true;
                        document.querySelectorAll('.role-card').forEach(c => c.classList.add('disabled'));
                        const logged = document.getElementById('loggedInInfo'); if (logged) logged.innerHTML = `<strong>${data.username}</strong> <span class="role-locked">${data.role}</span>`;
                        document.getElementById('loginBtn').classList.add('hidden');
                        document.getElementById('signupBtn').classList.add('hidden');
                        document.getElementById('logoutBtn').classList.remove('hidden');
                        // reveal main UI and hide the pre-login role-picker to avoid switching
                        roleSelectionEl.classList.add('hidden');
                        mainContainerEl.classList.remove('hidden');
                        setupDashboard(currentRole);
                    } else {
                        if (loginErrElm) { 
                            loginErrElm.textContent = data.message || 'Login failed';
                            loginErrElm.classList.remove('hidden'); 
                        }
                    }
                })
                .catch(err => {
                    const e = document.getElementById('loginError');
                    if (e) { e.textContent = 'Login error: ' + err; e.classList.remove('hidden'); }
                    else alert('Login error: ' + err);
                });
            });

            // Logout behavior
            document.getElementById('logoutBtn').addEventListener('click', function() {
                fetch('/logout', {method: 'POST'})
                .then(r => r.json())
                .then(() => {
                    currentRole = null;
                    isAuthenticated = false;
                    document.getElementById('loginRoleSelect').disabled = false;
                    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('disabled'));
                    document.getElementById('loggedInInfo').textContent = '';
                    document.getElementById('loginBtn').classList.remove('hidden');
                    document.getElementById('signupBtn').classList.remove('hidden');
                    document.getElementById('logoutBtn').classList.add('hidden');
                    // hide UI again
                    roleSelectionEl.classList.add('hidden');
                    mainContainerEl.classList.add('hidden');
                    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
                });
            });
        });
    </script>
</body>
</html>